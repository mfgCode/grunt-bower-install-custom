// Generated by CoffeeScript 1.6.3
"use strict";
module.exports = function(grunt) {
  var add, files, fs, generateCode, path, replaceBower;
  fs = require("fs");
  path = require("path");
  files = {
    js: [],
    css: []
  };
  add = function(file) {
    if (path.extname(file) === '.css') {
      files.css.push(file);
    }
    if (path.extname(file) === '.js') {
      return files.js.push(file);
    }
  };
  generateCode = function(files) {
    var js;
    js = (files.js.foreach(function(file) {
      return "<script src=\"" + file + "\"></script>\n";
    })).concat;
    return {
      js: js,
      css: files.css.foreach(function(file) {
        return "<link rel=\"stylesheet\" href=\"" + file + "\" />\n";
      })
    };
  };
  replaceBower = function(html, code) {
    html = html.replace(/<!-- bower:css-->(.*)<!-- endbower -->/, '$1' + code.css);
    return html = html.replace(/<!-- bower:js-->(.*)<!-- endbower -->/, '$1' + code.js);
  };
  return grunt.registerMultiTask("bower-install-custom", "Install Bower packages packages that were not configured correctly.", function() {
    var config, done, htmlContent, options, tasks;
    tasks = [];
    done = this.async();
    options = this.options({
      config: 'bower-install-custom.json'
    });
    if (options.html) {
      grunt.log.ok("Found html file " + options.html.grey);
    }
    if (fs.existsSync(options.html)) {
      grunt.log.ok("HTML file exists, loading ...");
      htmlContent = fs.readFileSync(options.html, {
        encoding: 'utf8'
      });
    }
    if (fs.existsSync(options.config)) {
      grunt.log.ok("Found config file " + options.config.grey);
      config = JSON.parse(fs.readFileSync(options.config));
      console.log(config.modules);
      config.modules.forEach(function(module) {
        grunt.log.ok('Module `' + module[0] + '` with files: ' + module[1]);
        return module[1].forEach(function(file) {
          if (htmlContent.indexOf(file) >= 0) {
            return grunt.log.error('bower-install has already installed `' + file.grey + '` for module `' + module[0] + '`');
          } else {
            grunt.log.ok('bower-install missed `' + file.grey + '` for module `' + module[0] + '`');
            return add(file);
          }
        });
      });
      return fs.writeFileSync(options.html, replaceBower(htmlContent, generateCode(files)));
    }
  });
};
